rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function authed(){ return request.auth != null; }
    function isStaff(){
      return authed() && get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role in ['admin','ta'];
    }

    // PUBLIC
    match /announcements/{id} { allow read: if true; allow write: if isStaff(); }

    // DASHBOARD
    match /enrollments/{id} { allow read, create, update: if authed(); }

    // messages: to == my uid OR "*"
    match /messages/{id} {
      allow create: if authed();
      allow read: if authed() &&
        (resource.data.to == request.auth.uid || resource.data.to == "*" || isStaff());
    }

    // users (own doc readable)
    match /users/{uid} {
      allow read: if authed() && (request.auth.uid == uid || isStaff());
      allow write: if authed() && (request.auth.uid == uid || isStaff());
    }

    // courses/lessons/quizzesâ€¦ (optional)
    match /courses/{id} { allow read: if true; allow write: if isStaff(); }
    match /lessons/{id} { allow read: if authed(); allow write: if isStaff(); }
    match /quizzes/{id} { allow read: if authed(); allow write: if isStaff(); }
    match /quizKeys/{id} { allow read, write: if isStaff(); }
  }
}